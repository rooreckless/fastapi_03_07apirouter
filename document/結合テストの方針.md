
# è³ªå•0.

```
ã§ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã¦ã€`docker compose exec pytest-fastapi pytest integrate_tests`ã§ã€DBã‚¢ã‚¯ã‚»ã‚¹ã«ä¼´ã†ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã—ã¾ã™ãŒã€ãã®éš›ã€ä»–ã«æ³¨æ„ã™ã¹ãã“ã¨ã¯ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚ä¾‹ãˆã°ã€é–‹ç™ºä¸­ã®DBã¨ã¯åˆ¥ã®ã€Œãƒ†ã‚¹ãƒˆç”¨ã®DBã‚’ä½œæˆã€ã—ãŸã‚Šã€ã€Œãã®ãƒ†ã‚¹ãƒˆç”¨DBã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€ã—ãŸã‚Šã—ã¦ã€çµåˆãƒ†ã‚¹ãƒˆæ™‚ã¯ãã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ãªã“ã¨ã§ã—ã‚‡ã†ã‹ã€‚
```

---
çµ±åˆãƒ†ã‚¹ãƒˆ (`integrate_tests`) ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«æ³¨æ„ã™ã¹ãã“ã¨ã¯ã€æ¬¡ã®ã‚ˆã†ã«å¤§ãã **4ã¤ã®è¦³ç‚¹** ã«æ•´ç†ã§ãã¾ã™ã€‚

---

## âœ… 1. **ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æœ¬ç•ªãƒ»é–‹ç™ºã¨åˆ†é›¢ã™ã‚‹**

### ç†ç”±ï¼š

æœ¬ç•ªãƒ»é–‹ç™ºã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã†ã¨ã€ãƒ†ã‚¹ãƒˆã«ã‚ˆã£ã¦äºˆæœŸã›ã¬ãƒ‡ãƒ¼ã‚¿ç ´å£ŠãŒèµ·ãã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

### å¯¾ç­–ï¼š

* `.env.test` ãªã©ã‚’ä½œã£ã¦ã€ãƒ†ã‚¹ãƒˆå°‚ç”¨DBã®æ¥ç¶šè¨­å®šã‚’ç®¡ç†ã€‚

* ä¾‹ï¼ˆ`.env.test`ï¼‰ï¼š

  ```env
  DATABASE_URL=postgresql+asyncpg://test_user:test_password@test-db:5432/test_db
  ```

* `docker-compose.override.yml` ã¾ãŸã¯ `docker-compose.test.yml` ã§ `test-db` ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã®ã‚‚è‰¯ã„æ§‹æˆã§ã™ã€‚

---

## âœ… 2. **ãƒ†ã‚¹ãƒˆç”¨DBã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æº–å‚™ã™ã‚‹**

### é¸æŠè‚¢ã¯2ã¤ï¼š

#### A. ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ã« Alembic ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨

```python
# ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
subprocess.run(["alembic", "upgrade", "head"])
```

#### B. `Base.metadata.create_all(bind=engine)` ã‚’ä½¿ã£ã¦ç›´æ¥ç”Ÿæˆ

è»½é‡ãªçµ±åˆãƒ†ã‚¹ãƒˆãªã‚‰ã“ã®æ–¹æ³•ã§ã‚‚OKã§ã™ã€‚

---

## âœ… 3. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‚’ä¿ã¤**

### ç†ç”±ï¼š

ãƒ‡ãƒ¼ã‚¿ã®æ®‹ç•™ã«ã‚ˆã£ã¦ä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã®ã‚’é˜²ããŸã‚ã€‚

### æ–¹æ³•ï¼š

* `pytest` ã® `fixture` ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡
* ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã« `rollback` ã¾ãŸã¯ `truncate` ã‚’å®Ÿæ–½

ä¾‹ï¼š

```python
@pytest.fixture
async def db_session():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
        await conn.run_sync(Base.metadata.create_all)
    async with async_session() as session:
        yield session
```

---

## âœ… 4. **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ç’°å¢ƒåˆ‡ã‚Šæ›¿ãˆ**

æœ¬ç•ªãƒ»é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆã®ç’°å¢ƒå¤‰æ•°ã‚’æ˜ç¢ºã«åˆ†ã‘ã¾ã—ã‚‡ã†ã€‚

### ä¾‹ï¼š

```bash
docker compose -f docker-compose.test.yml exec pytest-fastapi \
  env $(cat .env.test | xargs) \
  pytest integrate_tests/
```

ã‚‚ã—ãã¯ã€pytest ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ˜ç¤ºï¼š

```bash
pytest --envfile=.env.test integrate_tests/
```

---

## âœ… è£œè¶³ï¼šFastAPI + SQLAlchemy ã®ã‚ˆãã‚ã‚‹æ§‹æˆã§ã®å¯¾å‡¦ä¾‹

| é …ç›®        | é–‹ç™ºç”¨                  | çµ±åˆãƒ†ã‚¹ãƒˆç”¨                    |
| --------- | -------------------- | ------------------------- |
| DBå       | `app_db`             | `test_db`                 |
| æ¥ç¶šURL     | `.env` ã«å®šç¾©           | `.env.test` ã«å®šç¾©           |
| Alembic   | å®Ÿè¡Œã™ã‚‹ï¼ˆé–‹ç™ºãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰     | å®Ÿè¡Œã™ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰        |
| ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ    | `docker-compose.yml` | `docker-compose.test.yml` |
| ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ | `pytest tests`       | `pytest integrate_tests`  |

---

## âœ… ã¾ã¨ã‚

| è¦³ç‚¹              | å¿…é ˆã‹ | ç†ç”±               |
| --------------- | --- | ---------------- |
| ãƒ†ã‚¹ãƒˆç”¨DBã®åˆ†é›¢       | âœ…   | æœ¬ç•ªãƒ»é–‹ç™ºãƒ‡ãƒ¼ã‚¿ã‚’ç ´å£Šã—ãªã„ãŸã‚ |
| ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã®è‡ªå‹•åŒ–      | âœ…   | ãƒ†ã‚¹ãƒˆé–‹å§‹å‰ã«DBã‚’åˆæœŸçŠ¶æ…‹ã«  |
| å„ãƒ†ã‚¹ãƒˆã§DBã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ä¿ã¤ | âœ…   | ãƒ†ã‚¹ãƒˆã®ç‹¬ç«‹æ€§ã‚’ç¢ºä¿       |
| ç’°å¢ƒå¤‰æ•°ã®åˆ‡ã‚Šæ›¿ãˆ       | âœ…   | èª¤ã£ã¦é–‹ç™ºç’°å¢ƒã‚’æ“ä½œã—ãªã„ã‚ˆã†ã« |

---

å¿…è¦ã§ã‚ã‚Œã°ã€`docker-compose.test.yml` ã‚„ `pytestç”¨conftest.py` ã®å®Ÿä¾‹ã‚‚ãŠå‡ºã—ã§ãã¾ã™ã€‚ã©ã®ã‚ãŸã‚Šã‚’æ·±æ˜ã‚Šã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ



---

# è³ªå•1.

```
ã§ã¯ã€integerate_testsã«ã€ŒDBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã†ãƒ†ã‚¹ãƒˆã€ã‚’ä½œæˆã™ã‚‹æ™‚ã®è©±ã«æˆ»ã—ãŸã„ã®ã§ã™ãŒã€ã‚‚ã†å°‘ã—å…·ä½“çš„ãªæ–¹æ³•ã‚’è©°ã‚ã¦ã„ããŸã„ã§ã™ã€‚ç¾çŠ¶ã®docker-compose.ymlãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æˆã¯ä»¥ä¸‹ã§ã™ã€‚

<çœç•¥>

pytest-fastapiã‚µãƒ¼ãƒ“ã‚¹ã® volumesã«ã€- ./fastapi/integrate_tests:/fastapi/integrate_testsã‚’è¿½è¨˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã¯æ€ã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãŠã‚‰ã‚Šã¾ã›ã‚“ã€‚postgresã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€volumesã«- ./postgres/initdb:/docker-entrypoint-initdb.dã‚’è¨˜è¿°ã—ã¦ãŠã‚Šã€é…ç½®ã•ã‚ŒãŸsqlãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚Šå‡ºã—ã¦ã„ã‚‹ã®ã§ã™ã€‚ã“ã®ã‚ˆã†ãªçŠ¶æ…‹ã§ã€ã€Œdocker compose exec pytest-fastapi pytest integrate_testsã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ãŸæ™‚ã ã‘ã€ãƒ†ã‚¹ãƒˆç”¨DBã€ãƒ†ã‚¹ãƒˆç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã€ãƒ†ã‚¹ãƒˆãŒçµ‚äº†ã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆç”¨DBã€ãƒ†ã‚¹ãƒˆç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå»ƒæ£„ã•ã‚Œã‚‹ã€ã‚ˆã†ã«ã—ã€é–‹ç™ºç”¨ã®DBã«ã¯å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã§ãã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚
```


ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã„ãŸã ã„ãŸæ§‹æˆã‚’è¸ã¾ãˆã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°ã€Œ`integrate_tests` ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã ã‘ãƒ†ã‚¹ãƒˆç”¨DBãƒ»ãƒ†ã‚¹ãƒˆç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€çµ‚äº†æ™‚ã«ç ´æ£„ã™ã‚‹ã€ã“ã¨ãŒ**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã§ã‚‚å¯èƒ½**ã§ã™ã€‚

---

## âœ… ã‚„ã‚ŠãŸã„ã“ã¨ã®è¦ç´„

* **é–‹ç™ºç”¨DBã«ã¯ä¸€åˆ‡è§¦ã‚Œãš**
* `docker compose exec pytest-fastapi pytest integrate_tests` å®Ÿè¡Œæ™‚ã®ã¿ã€

  * ä¸€æ™‚çš„ãªã€Œãƒ†ã‚¹ãƒˆDBã€ã¨ãã®ä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
  * ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ã¯ç ´æ£„

---

## ğŸ”§ ä»•çµ„ã¿ã®å…¨ä½“åƒ

ã“ã®ç›®çš„ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ä»•çµ„ã¿ã‚’ä½¿ã„ã¾ã™ï¼š

| æ§‹æˆè¦ç´                       | å†…å®¹                                                    |
| ------------------------- | ----------------------------------------------------- |
| **ãƒ†ã‚¹ãƒˆDBå**                | `test_appdb` ã®ã‚ˆã†ãªåˆ¥åã«ã™ã‚‹                                |
| **pytest conftest.py**    | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã« `test_appdb` ã‚’ `CREATE DATABASE` ã—ã€SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æµã™ |
| **SQLã®èª­ã¿è¾¼ã¿**              | `psycopg` ã¾ãŸã¯ `asyncpg` ã§SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ           |
| **ãƒ†ã‚¹ãƒˆå¾Œã«DROP**             | ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã« `DROP DATABASE test_appdb` ã‚’å®Ÿè¡Œ                |
| **`.envs/test/postgres`** | ãƒ†ã‚¹ãƒˆç”¨ã« `POSTGRES_DB=test_appdb` ã‚’å®šç¾©ã—ãŸå°‚ç”¨ `.env` ã‚’ç”¨æ„ã™ã‚‹   |

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆè¿½åŠ ï¼‰

```bash
.envs/
â”œâ”€â”€ local/
â”‚   â””â”€â”€ postgres  # â† é–‹ç™ºç”¨ï¼ˆæ—¢å­˜ï¼‰
â””â”€â”€ test/
    â””â”€â”€ postgres  # â† ãƒ†ã‚¹ãƒˆç”¨ï¼ˆæ–°è¦ï¼‰
fastapi/
â”œâ”€â”€ app/
â”œâ”€â”€ integrate_tests/
â”‚   â”œâ”€â”€ conftest.py
â”‚   â””â”€â”€ test_xxx.py
```

---

## ğŸ³ docker-compose.yml ã¸ã®å¤‰æ›´ç‚¹

```yaml
pytest-fastapi:
  ...
  env_file:
    - .envs/test/postgres  # â† ã“ã“ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆæœ¬ç•ªã¨åŒºåˆ¥ï¼‰
  volumes:
    ...
    - ./fastapi/integrate_tests:/fastapi/integrate_tests  # â† è¿½åŠ 
```

---

## ğŸ§ª conftest.py ã®ä¾‹ï¼ˆç°¡æ˜“ç‰ˆï¼‰

```python
import asyncio
import os
import pytest
import asyncpg

@pytest.fixture(scope="session")
def event_loop():
    loop = asyncio.get_event_loop()
    yield loop
    loop.close()

@pytest.fixture(scope="session", autouse=True)
async def setup_test_db():
    # ç®¡ç†DBã«æ¥ç¶š
    admin_conn = await asyncpg.connect(
        user=os.getenv("POSTGRES_USER"),
        password=os.getenv("POSTGRES_PASSWORD"),
        database="postgres",  # â† ç®¡ç†DBã§æ¥ç¶š
        host=os.getenv("POSTGRES_HOST", "localhost")
    )

    test_db_name = os.getenv("POSTGRES_DB")

    # DBä½œæˆï¼ˆå­˜åœ¨ã™ã‚Œã°å‰Šé™¤ï¼‰
    await admin_conn.execute(f"DROP DATABASE IF EXISTS {test_db_name};")
    await admin_conn.execute(f"CREATE DATABASE {test_db_name};")
    await admin_conn.close()

    # ä½œã£ãŸDBã«æ¥ç¶šã—ã¦åˆæœŸSQLæµã—è¾¼ã¿
    test_conn = await asyncpg.connect(
        user=os.getenv("POSTGRES_USER"),
        password=os.getenv("POSTGRES_PASSWORD"),
        database=test_db_name,
        host=os.getenv("POSTGRES_HOST", "localhost")
    )

    with open("/docker-entrypoint-initdb.d/init.sql") as f:
        sql = f.read()
        await test_conn.execute(sql)

    await test_conn.close()

    yield  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼

    # ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«å‰Šé™¤
    admin_conn = await asyncpg.connect(
        user=os.getenv("POSTGRES_USER"),
        password=os.getenv("POSTGRES_PASSWORD"),
        database="postgres",
        host=os.getenv("POSTGRES_HOST", "localhost")
    )
    await admin_conn.execute(f"DROP DATABASE IF EXISTS {test_db_name};")
    await admin_conn.close()
```

---

## ğŸ“„ .envs/test/postgres ã®ä¾‹

```env
POSTGRES_DB=test_appdb
POSTGRES_USER=appuser
POSTGRES_PASSWORD=apppassword
POSTGRES_HOST=postgres
```

â€»ä»–ã®è¨­å®šï¼ˆDB\_PORTãªã©ï¼‰ã‚‚ `.envs/local/postgres` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ§¼ é–‹ç™ºç”¨DBã¸ã®å½±éŸ¿ã‚’é¿ã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆ

* æ¥ç¶šå…ˆã¯å¸¸ã« `test_appdb`
* `init.sql` ã¯é–‹ç™ºã§ã‚‚ãƒ†ã‚¹ãƒˆã§ã‚‚å…±é€šã«ä½¿ãˆã‚‹ï¼ˆæµç”¨ã§ãã‚‹ï¼‰
* ãƒ†ã‚¹ãƒˆç”¨DBä½œæˆã¨å‰Šé™¤ã‚’ãƒ†ã‚¹ãƒˆå‰å¾Œã« **è‡ªå‹•åŒ–**
* Alembicã¯ä½¿ã‚ãªãã¦ã‚‚å•é¡Œãªã—

---

## âœ… ã¾ã¨ã‚

| é …ç›®               | èª¬æ˜                                   |
| ---------------- | ------------------------------------ |
| ãƒ†ã‚¹ãƒˆç”¨DBã®ä½œæˆæ–¹æ³•      | `conftest.py` ã§ `CREATE DATABASE` å®Ÿè¡Œ |
| ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ–¹æ³•         | `init.sql` ã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œï¼ˆpsycopgã§ã‚‚OKï¼‰     |
| ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—   | `DROP DATABASE` ã‚’ `yield` ã®å¾Œã§å®Ÿè¡Œ      |
| é–‹ç™ºç”¨DBã¸ã®å½±éŸ¿        | ä¸€åˆ‡ãªã—ã€åˆ¥ã®DBã‚’ä½¿ã†ãŸã‚å®‰å…¨                     |
| docker-composeä¿®æ­£ | `volumes` ã¨ `env_file` ã«ãƒ†ã‚¹ãƒˆç”¨è¨­å®šã‚’è¿½åŠ     |

---

å¿…è¦ã«å¿œã˜ã¦ã€ä¸Šè¨˜æ§‹æˆã‚’ã‚ãªãŸã® `fastapi` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æœ€é©åŒ–ã—ãŸå½¢ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã‚„æ§‹æˆèª¿æ•´ã‚‚ãŠæ‰‹ä¼ã„å¯èƒ½ã§ã™ã€‚ç¶šãã‚’ã”å¸Œæœ›ã§ã—ãŸã‚‰ã”æŒ‡ç¤ºãã ã•ã„ã€‚


---

# è³ªå•2.

```
ä»¥å‰ã‚ãªãŸã«æç¤ºã—ãŸdocker-compose.ymlã§ã¯pytest-fastapiã‚µãƒ¼ãƒ“ã‚¹ã®env_fileã«`.envs/local/postgres`ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ã€ã‚ãªãŸã¯çŸ¥ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ãã®`.envs/local/postgres`ã®è¨˜è¿°å†…å®¹ã¯ä»¥ä¸‹ã§ã™ã€‚
    ```
    POSTGRES_USER=fastapi_user
    POSTGRES_PASSWORD=fastapi_pass
    POSTGRES_DB=fastapi_db

    #DATABASE_URL=postgresql://fastapi_user:fastapi_pass@db:5432/fastapi_db
    DATABASE_URL=postgresql+asyncpg://fastapi_user:fastapi_pass@postgres:5432/fastapi_db
    SYNC_DATABASE_URL=postgresql+psycopg2://fastapi_user:fastapi_pass@postgres:5432/fastapi_db
    ```
ã‚ãªãŸã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’pytest_fastapiã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒ³ãƒ‰ãƒã‚¦ãƒ³ãƒˆã›ãšã€åˆ¥ã®`.envs/test/postgres`ã®æ–¹ã‚’ãƒã‚¤ãƒ³ãƒ‰ãƒã‚¦ãƒ³ãƒˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ä½¿ã†ç’°å¢ƒå¤‰æ•°ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ã“ã¨ã«ãªã‚‹ã¯ãšã§ã™ãŒã€å˜ä½“ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ä»Šã¾ã§ä½¿ã£ã¦ã„ãŸã‚³ãƒãƒ³ãƒ‰`docker compose exec pytest-fastapi pytest tests`ã¨ã€ã“ã‚Œã‹ã‚‰æ­è¼‰ã™ã‚‹integrate_testsã«ã‚ˆã‚‹DBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã†ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰`docker compose exec pytest-fastapi pytest integrate_tests`ã‚‚ä¸¡æ–¹ã¨ã‚‚å®Ÿè¡Œã§ãã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚
```
---

ã”æŒ‡æ‘˜ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠã£ã—ã‚ƒã‚‹ã¨ãŠã‚Šã€ç¾åœ¨ã® `docker-compose.yml` ã§ã¯ `pytest-fastapi` ã‚µãƒ¼ãƒ“ã‚¹ã« **`.envs/local/postgres` ãŒæ˜ç¤ºçš„ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹** çŠ¶æ…‹ã§ã™ã€‚ãã—ã¦ã€ã“ã® `.envs/local/postgres` ã¯ **é–‹ç™ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `fastapi_db`** ã«æ¥ç¶šã™ã‚‹è¨­å®šã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã§å•é¡Œã«ãªã‚‹ã®ã¯ã€ä»¥ä¸‹ã®2ç‚¹ã§ã™ï¼š

---

## ğŸ” å•é¡Œã®æ•´ç†

### âœ… ä»Šã®çŠ¶æ…‹

* `.envs/local/postgres` ã«ã¯é–‹ç™ºç”¨DBï¼ˆ`fastapi_db`ï¼‰ã¸ã®æ¥ç¶šæƒ…å ±ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
* `docker compose exec pytest-fastapi pytest tests` ã§ã¯ã“ã®æ¥ç¶šæƒ…å ±ã‚’ä½¿ã£ã¦é–‹ç™ºç”¨DBã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹ï¼ˆãŸã ã—DBã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚‚å«ã‚€ï¼‰ã€‚
* `volumes` ã‚’ä½¿ã£ã¦ `.envs/local/postgres` ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€`env_file` ã«ã‚ˆã‚Šç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã€‚

### â—ï¸æ–°ãŸã«ã‚„ã‚ŠãŸã„ã“ã¨

* `pytest-fastapi` ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ **åˆ¥ã®DBï¼ˆä¾‹ï¼š`test_fastapi_db`ï¼‰ã‚’ä¸€æ™‚çš„ã«ä½œæˆã—ã¦ä½¿ã„ãŸã„**ã€‚
* ãŸã ã— `.envs/test/postgres` ã‚’ `env_file` ã«æŒ‡å®šã—ã¦ã—ã¾ã†ã¨ã€æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒä¾å­˜ã—ã¦ã„ã‚‹ `.envs/local/postgres` ã¨ã¯åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã—ã¾ã„ã€**æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹ãŠãã‚Œ**ãŒã‚ã‚‹ã€‚

---

## ğŸ§© è§£æ±ºç­–

### âœ… çµè«–ï¼š\*\*`.envs/local/postgres` ã®ã¾ã¾ã§çµ±ä¸€ã—ã€conftest.pyã®ä¸­ã§ã€Œå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€\*\*æ–¹å¼ãŒæœ€ã‚‚å®‰å…¨ã§æŸ”è»Ÿã§ã™ã€‚

---

## âœ… è§£æ±ºæ‰‹æ³•ã®è©³ç´°

### â‘  `.envs/local/postgres` ã¯**ãã®ã¾ã¾**ä½¿ç”¨

* `env_file` ã«å¤‰æ›´ãªã—
* ä»Šã® `docker compose exec pytest-fastapi pytest tests` ã‚‚å£Šã‚Œãªã„
* DBåã¯ `fastapi_db` ã®ã¾ã¾ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã•ã‚Œã‚‹

### â‘¡ `integrate_tests/conftest.py` ã®ä¸­ã§ **æ¥ç¶šå…ˆDBåã ã‘ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´**

```python
import os
import asyncio
import pytest
import asyncpg
from urllib.parse import urlparse, urlunparse

def _modify_database_name(db_url: str, new_db_name: str) -> str:
    parsed = urlparse(db_url)
    new_path = "/" + new_db_name
    return urlunparse(parsed._replace(path=new_path))

@pytest.fixture(scope="session", autouse=True)
async def setup_test_db():
    original_url = os.environ["DATABASE_URL"]
    test_db_name = "test_fastapi_db"
    test_db_url = _modify_database_name(original_url, test_db_name)

    # ä¸€æ™‚çš„ã«ç’°å¢ƒå¤‰æ•°ã‚’æ›¸ãæ›ãˆ
    os.environ["DATABASE_URL"] = test_db_url

    # ç®¡ç†DBï¼ˆpostgresï¼‰ã«æ¥ç¶š
    admin_url = _modify_database_name(original_url, "postgres")
    admin_conn = await asyncpg.connect(admin_url)

    await admin_conn.execute(f"DROP DATABASE IF EXISTS {test_db_name};")
    await admin_conn.execute(f"CREATE DATABASE {test_db_name};")
    await admin_conn.close()

    # åˆæœŸãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆä¾‹: init.sqlã‚’æµã™ãªã©ï¼‰
    conn = await asyncpg.connect(test_db_url)
    with open("/docker-entrypoint-initdb.d/init.sql") as f:
        sql = f.read()
        await conn.execute(sql)
    await conn.close()

    yield  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

    # ãƒ†ã‚¹ãƒˆDBå‰Šé™¤
    admin_conn = await asyncpg.connect(admin_url)
    await admin_conn.execute(f"DROP DATABASE IF EXISTS {test_db_name};")
    await admin_conn.close()

    # ç’°å¢ƒå¤‰æ•°ã‚’æˆ»ã™ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    os.environ["DATABASE_URL"] = original_url
```

---

## âœ… ã“ã®æ–¹å¼ã®ãƒ¡ãƒªãƒƒãƒˆ

| é …ç›®                                     | èª¬æ˜                                                |
| -------------------------------------- | ------------------------------------------------- |
| **æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œãªã„**                        | `.envs/local/postgres` ã®ã¾ã¾ãªã®ã§ `tests/` ã¯ã“ã‚Œã¾ã§é€šã‚Šå®Ÿè¡Œå¯ |
| **`integrate_tests/` ã ã‘ãŒ test DB ã«æ¥ç¶š** | `conftest.py` ãŒè‡ªå‹•çš„ã« `DATABASE_URL` ã‚’æ›¸ãæ›ãˆã‚‹         |
| **env\_file ã®åˆ‡ã‚Šæ›¿ãˆä¸è¦**                  | docker-compose.yml ã‚’ä¸€åˆ‡å¤‰æ›´ã—ãªãã¦è‰¯ã„                    |
| **ãƒ†ã‚¹ãƒˆã”ã¨ã«å®Œå…¨ã«DBã‚’åˆ†é›¢ã§ãã‚‹**                  | `CREATE DATABASE` / `DROP DATABASE` ã«ã‚ˆã‚Šå®Œå…¨éš”é›¢å¯èƒ½     |

---

## âœ… å®Ÿè¡Œä¾‹

```bash
# å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºç”¨DBæ¥ç¶šï¼‰
docker compose exec pytest-fastapi pytest tests

# çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨DBã‚’å‹•çš„ã«ä½œæˆãƒ»å‰Šé™¤ï¼‰
docker compose exec pytest-fastapi pytest integrate_tests
```

---

## âœ³ï¸ è£œè¶³ï¼ˆå¤±æ•—ä¾‹ï¼‰

`.envs/test/postgres` ã‚’ `env_file` ã«è¿½åŠ ãƒ»åˆ‡ã‚Šæ›¿ãˆã—ã¦ã—ã¾ã†ã¨â€¦

* `pytest tests` ã®æ–¹ãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ï¼ˆäºˆæœŸã—ãªã„DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
* ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†ãŒè¤‡é›‘åŒ–ã—ã€CIç’°å¢ƒã§ã‚‚æ··ä¹±ãŒèµ·ãã‚„ã™ããªã‚‹

---

## âœ… ã¾ã¨ã‚

| æ–¹æ³•                                      | çµè«–                      |
| --------------------------------------- | ----------------------- |
| `.envs/test/postgres` ã‚’åˆ¥é€”ä½¿ã†             | âŒ **é¿ã‘ã‚‹ã¹ã**ï¼ˆæ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®ä¸æ•´åˆï¼‰ |
| `conftest.py` å†…ã§ `DATABASE_URL` ã‚’ä¸€æ™‚æ›¸ãæ›ãˆ | âœ… **æ¨å¥¨**ï¼ˆç’°å¢ƒåˆ‡ã‚Šæ›¿ãˆãªã—ã§å®‰å…¨ï¼‰   |

---

ã”å¸Œæœ›ãŒã‚ã‚Œã°ã€ä¸Šè¨˜ã® `conftest.py` ã‚’ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã«ã‚ã‚ã›ã¦å¾®èª¿æ•´ã—ã¦æä¾›ã„ãŸã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚




# è³ªå•3.

```
integrate_testsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆã™ã‚‹ãƒ†ã‚¹ãƒˆã¯ã€Œç¾åœ¨ã®ã¨ã“ã‚ã¯ã€DBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã†ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹äºˆå®šã§ã™ãŒã€å°†æ¥çš„ã«ã¯ä»–ã®ãƒ†ã‚¹ãƒˆã‚‚å…¥ã£ã¦ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã€`integrate_tests/conftest.py`ã«ã‚ãªãŸãŒè€ƒãˆãŸå†…å®¹ã®ã‚‚ã®ã‚’é…ç½®ã—ãŸå ´åˆã€ã€Œintegrate_testsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã•ã‚ŒãŸã€DBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã†ãƒ†ã‚¹ãƒˆã€Œä»¥å¤–ã®ãƒ†ã‚¹ãƒˆã€ã€ã‚‚ã€ãã®`integrate_tests/conftest.py`ã®å½±éŸ¿ã‚’å—ã‘ã¦ã—ã¾ã†ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã€‚
```

---

ã¯ã„ã€ã”æŒ‡æ‘˜ã®ã¨ãŠã‚Šã§ã™ã€‚`integrate_tests/conftest.py` ã«ã€ŒDBæ¥ç¶šå…ˆã®ç’°å¢ƒå¤‰æ•°ã‚’æ›¸ãæ›ãˆã‚‹ fixtureã€ã‚’æ›¸ã„ãŸå ´åˆã€**ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ãŒåŠã³ã¾ã™**ã€‚ã¤ã¾ã‚Šã€å°†æ¥çš„ã«è¿½åŠ ã•ã‚Œã‚‹ **DBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã‚ãªã„ãƒ†ã‚¹ãƒˆã§ã‚ã£ã¦ã‚‚ã€æ„å›³ã›ãš `test_fastapi_db` ã«æ¥ç¶šã•ã‚Œã¦ã—ã¾ã†** ã¨ã„ã†å‰¯ä½œç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã“ã‚Œã¯é¿ã‘ã‚‹ã¹ããªã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹é‡è»¢æ›ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚

---

## âœ… è§£æ±ºç­–ï¼š`conftest.py` ã®å½±éŸ¿ç¯„å›²ã‚’çµã‚‹æ–¹æ³•

### æ–¹æ³•1ï¼š`autouse=True` ã‚’ã‚„ã‚ã¦ã€**å¿…è¦ãªãƒ†ã‚¹ãƒˆã ã‘ fixture ã‚’æ˜ç¤ºçš„ã«ä½¿ã†**

```python
# integrate_tests/conftest.py
@pytest.fixture(scope="session")
async def setup_test_db():
    ...
```

ãã—ã¦ã€DBã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆã ã‘ã“ã†æ›¸ãã¾ã™ï¼š

```python
@pytest.mark.asyncio
async def test_create_item_with_db(setup_test_db):
    ...
```

âœ… ã“ã®æ–¹æ³•ãªã‚‰ã€**setup\_test\_db ã‚’å¼•æ•°ã«æ›¸ã„ãŸãƒ†ã‚¹ãƒˆã ã‘ãŒ test DB ã‚’ä½¿ã†**ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

### æ–¹æ³•2ï¼šãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½ã§ `usefixtures` ã‚’æŒ‡å®šï¼ˆclassã‚„fileã®å…ˆé ­ã§ï¼‰

```python
# integrate_tests/test_with_db/test_create.py

import pytest

pytestmark = pytest.mark.usefixtures("setup_test_db")

@pytest.mark.asyncio
async def test_create_item():
    ...
```

ãã—ã¦ã€DBä¸è¦ã®ãƒ†ã‚¹ãƒˆã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†ã‘ã‚‹ã“ã¨ã§ã€è‡ªç„¶ã¨ fixture ã®å½±éŸ¿å¤–ã«ç½®ã‘ã¾ã™ã€‚

---

### æ–¹æ³•3ï¼špytest ã® `--ignore` ã‚„ `-k` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå˜ä½ã®å®Ÿè¡Œã‚’åˆ†ã‘ã‚‹ï¼ˆè£œåŠ©çš„æ‰‹æ®µï¼‰

ãŸã¨ãˆã° `integrate_tests/test_with_db/` é…ä¸‹ã®ã¿ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œï¼š

```bash
docker compose exec pytest-fastapi pytest integrate_tests/test_with_db
```

---

## âœ… è£œè¶³ï¼šå°†æ¥çš„ãªæ‹¡å¼µæ€§ã‚’è€ƒãˆãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†å‰²æ¡ˆ

ä»Šå¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã®ç²’åº¦ãŒå¢—ãˆã¦ã„ããªã‚‰ï¼š

```
integrate_tests/
â”œâ”€â”€ test_with_db/
â”‚   â””â”€â”€ test_create.py
â”œâ”€â”€ test_without_db/
â”‚   â””â”€â”€ test_api_contract.py
```

* `test_with_db/` ã®ä¸­ã§ã ã‘ `setup_test_db` fixture ã‚’ä½¿ã†
* `test_without_db/` ã§ã¯ä½•ã‚‚ä½¿ã‚ãªã„

ã¨ã™ã‚‹ã®ãŒæœ€ã‚‚å‰¯ä½œç”¨ãŒãªãã€æŸ”è»Ÿã§ã™ã€‚

---

## âœ… ã¾ã¨ã‚

| æ–¹æ³•                   | fixture ã®å½±éŸ¿ç¯„å›²    | å‚™è€ƒ          |
| -------------------- | ---------------- | ----------- |
| `autouse=True` ã®ã¾ã¾   | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹å…¨ä½“       | âŒå‰¯ä½œç”¨ã‚ã‚Šï¼ˆéæ¨å¥¨ï¼‰ |
| fixture ã‚’æ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™    | è©²å½“ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿        | âœ…å®‰å…¨ãƒ»æ¨å¥¨      |
| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½ã§ usefixtures | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã§ç®¡ç†ã—ã‚„ã™ã„ | âœ…ç®¡ç†ã—ã‚„ã™ã„     |
| ãƒ†ã‚¹ãƒˆã‚’ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§åˆ†é›¢      | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§æ˜ç¢ºã«åˆ†é›¢     | âœ…ãƒãƒ¼ãƒ é–‹ç™ºã«ã‚‚æœ€é©  |

---

å¿…è¦ã§ã‚ã‚Œã°ã€ã“ã‚Œã«æ²¿ã£ãŸ `conftest.py` ã®å†æ§‹æˆã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆæ¡ˆã®ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã‚‚ã”ç”¨æ„ã—ã¾ã™ã€‚ãŠæ°—è»½ã«ã©ã†ãã€‚


# è³ªå•4

```
æ–¹æ³•1ã‚’åŸºæœ¬ãƒ™ãƒ¼ã‚¹ã¨ã—ã¤ã¤ã€integrate_testsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã‚‚ã€ã€Œå®Ÿéš›ã«DBã‚¢ã‚¯ã‚»ã‚¹ã®ä¼´ã†ãƒ†ã‚¹ãƒˆã€ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªä½“ã«ã‚‚ã€è¿½åŠ ã§conftest.pyã‚’é…ç½®ã™ã‚‹ã®ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚ãã†ã™ã‚Œã°ã€çµåˆãƒ†ã‚¹ãƒˆè‡ªä½“ã«å¿…è¦ãªDBæ¥ç¶šã®ãŸã‚ã®ã€Œæ˜ç¤ºçš„ã«å‘¼ã°ãªã‘ã‚Œã°ãªã‚‰ãªã„setup_test_dbã€ã¯`integrate_tests/conftest.py`ã«è¨˜è¿°ã•ã‚Œã€ä¸€æ–¹ã€çµåˆãƒ†ã‚¹ãƒˆã®éš›ã«ã€å¿…è¦ã¨ãªã‚‹ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å®šç¾©ãªã©ã¯ã€çµåˆãƒ†ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨åŒéšå±¤ã®conftest.pyã§æ‹…å½“ã§ãã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚
```

---

ã¯ã„ã€ãã®è¨­è¨ˆæ–¹é‡ã¯éå¸¸ã«ç†ã«ã‹ãªã£ã¦ãŠã‚Šã€**ãƒ†ã‚¹ãƒˆã®è²¬å‹™ã‚’é©åˆ‡ã«åˆ†é›¢**ã§ãã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®1ã¤ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«è€ƒãˆã‚‹ã¨ã€æ§‹é€ ãŒã‚ˆã‚Šæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

---

## âœ… ææ¡ˆã•ã‚ŒãŸæ§‹æˆã®æ„å›³ã¨åˆ©ç‚¹

| ç›®çš„                | é…ç½®                                         | å†…å®¹                                |
| ----------------- | ------------------------------------------ | --------------------------------- |
| DBæ¥ç¶šã‚„ç’°å¢ƒè¨­å®šï¼ˆå…±é€šï¼‰     | `integrate_tests/conftest.py`              | `setup_test_db` ãªã©ã®å…±é€š fixture ã‚’å®šç¾© |
| ãƒ†ã‚¹ãƒˆã”ã¨ã®å€‹åˆ¥è¨­å®šã‚„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ | `integrate_tests/feature_x/conftest.py` ãªã© | ãƒ†ã‚¹ãƒˆå¯¾è±¡ã«ç‰¹åŒ–ã—ãŸ fixture ã‚„ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’å®šç¾©      |

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ï¼š

* \*\*å…±é€šã®æº–å‚™ï¼ˆDBæ¥ç¶šã®åˆ‡æ›¿ãªã©ï¼‰\*\*ã¯ä¸Šä½ã® `conftest.py` ã«é›†ç´„ã—ã€
* **å€‹åˆ¥ãƒ†ã‚¹ãƒˆç”¨ã®fixtureã‚„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ**ã¯ãã®ãƒ†ã‚¹ãƒˆã¨åŒéšå±¤ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## âœ… å®Ÿéš›ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚¤ãƒ¡ãƒ¼ã‚¸

```bash
integrate_tests/
â”œâ”€â”€ conftest.py  # å…±é€šã®setup_test_dbãªã©
â”œâ”€â”€ feature_x/
â”‚   â”œâ”€â”€ conftest.py  # feature_xç”¨ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â””â”€â”€ test_something.py
â”œâ”€â”€ feature_y/
â”‚   â”œâ”€â”€ conftest.py  # feature_yç”¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ã‚Œã°ï¼‰
â”‚   â””â”€â”€ test_another.py
```

---

## âœ… Pytest ã«ãŠã‘ã‚‹ conftest.py ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®ä»•çµ„ã¿

* Pytest ã¯ã€**è‡ªåˆ†ã¨åŒã˜ã‹è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `conftest.py`** ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚
* ãã®ãŸã‚ã€`integrate_tests/feature_x/conftest.py` ã¯ã€`test_something.py` ã‹ã‚‰è‡ªç„¶ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
* åŒåã® fixture ãŒè¦ªã¨å­ã®ä¸¡æ–¹ã«å­˜åœ¨ã™ã‚‹å ´åˆã€**å­ã® fixture ãŒå„ªå…ˆã•ã‚Œã¾ã™ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰**ã€‚

---

## âœ… Fixture ã®åˆ©ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
# integrate_tests/conftest.py

@pytest.fixture(scope="session")
async def setup_test_db():
    # DB URLã®ç’°å¢ƒå¤‰æ•°åˆ‡ã‚Šæ›¿ãˆãªã©
    ...
```

```python
# integrate_tests/feature_x/conftest.py

@pytest.fixture
async def create_user():
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    ...
```

```python
# integrate_tests/feature_x/test_something.py

@pytest.mark.asyncio
async def test_create_user(setup_test_db, create_user):
    user = await create_user()
    assert user.email == "test@example.com"
```

---

## âœ… å°†æ¥ã®æ‹¡å¼µã‚‚å®‰å¿ƒ

* `integrate_tests/feature_z/` ã« DB ã‚’ä½¿ã‚ãªã„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã‚‚ã€

  * `setup_test_db` ã‚’ fixture å¼•æ•°ã«å…¥ã‚Œãªã„é™ã‚Šå®Ÿè¡Œæ™‚ã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚
* å¿…è¦ã«ãªã‚Œã°ã€`feature_z/conftest.py` ã«ç‹¬è‡ªã® fixture ã‚’å®šç¾©ã§ãã¾ã™ã€‚

---

## âœ… ã¾ã¨ã‚

ã‚ãªãŸã®ææ¡ˆé€šã‚Šã« \*\*ã€Œå…±é€šã¨å€‹åˆ¥ã‚’åˆ†ã‘ã¦ conftest.py ã‚’é…ç½®ã€\*\*ã™ã‚‹æ–¹æ³•ã¯ã€æ¬¡ã®ç‚¹ã§å„ªã‚Œã¦ã„ã¾ã™ï¼š

* âœ… çµåˆãƒ†ã‚¹ãƒˆã«å¿…è¦ãªå…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®é›†ä¸­ç®¡ç†
* âœ… æ©Ÿèƒ½å˜ä½ã§ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚„å‰å‡¦ç†ã®ã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç†
* âœ… å°†æ¥ã®æ‹¡å¼µã«ã‚‚æŸ”è»Ÿã«å¯¾å¿œå¯èƒ½

ã“ã®æ–¹é‡ã§é€²ã‚ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚å¿…è¦ã§ã‚ã‚Œã°ã€å…·ä½“çš„ãª `conftest.py` ã®ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚ãŠæ¸¡ã—ã§ãã¾ã™ã€‚

# è³ªå•5.

```
ã„ã¾ã¾ã§ç«‹ã¦ã¦ããŸæ–¹é‡ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€
â‘  .envs/local/postgres ã¯ãã®ã¾ã¾ä½¿ç”¨
â‘¡ integrate_tests/conftest.py ã®ä¸­ã§ æ¥ç¶šå…ˆDBåã ã‘ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã™ã‚‹ã€‚ãŸã ã—ã€ã“ã®conftest.pyã¯setup_test_dbãƒ¡ã‚½ãƒƒãƒ‰ã«autouse=Trueã‚’ä½¿ç”¨ã›ãšã«ã€@pytest.fixture(scope="session")ä»˜ãã§å®šç¾©ã™ã‚‹ã€‚
ã¨ã„ã†ã“ã¨ã§ã™ã‚ˆã­ã€‚
ã ã¨ã—ãŸã‚‰ã€â‘¡ã®æ®µéšã§ã€ã€Œãƒ†ã‚¹ãƒˆç”¨ã®DBã«æ¥ç¶šã™ã‚‹ã€ã ã‘ã§ãªãã€ã€Œãƒ†ã‚¹ãƒˆç”¨ã®DBã‚’ä½œæˆã—ã€æ¥ç¶šã—ãŸå¾Œã¯ã€init.sqlã®å†…å®¹ã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€ãŒå¿…è¦ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã‹?
```

---

ã¯ã„ã€ã‚ãªãŸã®æ–¹é‡ã®æ•´ç†ã¯ã»ã¼æ­£ç¢ºã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã¾ã¨ã‚ã‚‰ã‚Œã¾ã™ï¼š

---

## âœ… æ–¹é‡ã®ç¢ºèªã¨è£œè¶³

### â‘  `.envs/local/postgres` ã¯ãã®ã¾ã¾ä½¿ç”¨

* é–‹ç™ºç”¨ãƒ»çµåˆãƒ†ã‚¹ãƒˆç”¨ã§ã€ŒåŒã˜DBãƒ›ã‚¹ãƒˆï¼ˆãŸã¨ãˆã° `postgres` ã‚³ãƒ³ãƒ†ãƒŠï¼‰ã€ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
* `.env` ã®ä¸­ã«è¨˜è¼‰ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ›ã‚¹ãƒˆã€ãƒãƒ¼ãƒˆã¯æµç”¨ã€‚
* ãŸã ã—ã€ŒDBåï¼ˆ`POSTGRES_DB`ï¼‰ã€ã ã‘ã‚’ãƒ†ã‚¹ãƒˆç”¨ã«ä¸€æ™‚çš„ã«å·®ã—æ›¿ãˆã¦ä½¿ã†æ§‹æˆã€‚

---

### â‘¡ `integrate_tests/conftest.py` ã§DBåã®å¤‰æ›´ã¨ãƒ†ã‚¹ãƒˆç”¨DBã®æ¥ç¶š

```python
# integrate_tests/conftest.py
@pytest.fixture(scope="session")
async def setup_test_db():
    ...
```

* `autouse=True` ã¯ä½¿ã‚ãšã€**å¿…è¦ãªãƒ†ã‚¹ãƒˆã ã‘ãŒã“ã® fixture ã‚’æ˜ç¤ºçš„ã«å‘¼ã¶**ã€‚
* ãƒ†ã‚¹ãƒˆç”¨ã®DBåï¼ˆãŸã¨ãˆã° `app_test`ï¼‰ã‚’ `.env.test` ã‹ã‚‰èª­ã¿è¾¼ã‚€ or ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã‚‚å¯ã€‚
* ãƒ†ã‚¹ãƒˆç”¨DBåã‚’å…ƒã«ã€Œæ¥ç¶šURLï¼ˆ`DATABASE_URL`ï¼‰ã€ã‚’ä¸€æ™‚çš„ã«å·®ã—æ›¿ãˆã‚‹ã€‚

---

## âœ… é‡è¦ãªè£œè¶³ï¼šã€Œãƒ†ã‚¹ãƒˆç”¨DBã®ä½œæˆãƒ»åˆæœŸåŒ–ã€

ã“ã“ãŒä»Šå›ã®è³ªå•ã®ãƒã‚¤ãƒ³ãƒˆã§ã™ã­ã€‚

### âœ… Yes: **ã€Œãƒ†ã‚¹ãƒˆç”¨ã®DBã‚’ä½œæˆãƒ»åˆæœŸåŒ–ã€ã™ã‚‹è²¬ä»»ã‚‚ `setup_test_db()` ã«ã‚ã‚‹ã¹ã**ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ãŒå«ã¾ã‚Œã¾ã™ï¼š

---

### âœ… `setup_test_db()` ã«å«ã‚ã‚‹å‡¦ç†ã®æ¦‚è¦

1. **DBåã‚’ `app_test` ãªã©ã«å¤‰æ›´ã—ãŸ `DATABASE_URL` ã‚’æ§‹ç¯‰**
2. **PostgreSQLã«ã€Œç®¡ç†DBï¼ˆä¾‹ï¼š`postgres`ï¼‰ã€ã§æ¥ç¶šã—ã€`app_test` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ**

   * ã™ã§ã«å­˜åœ¨ã—ã¦ã„ã‚Œã° DROP â†’ CREATE ã™ã‚‹ã®ãŒå®‰å…¨ï¼ˆã¾ãŸã¯ truncateï¼‰ã€‚
3. **ä½œæˆã—ãŸ `app_test` ã«æ¥ç¶šã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’å®Ÿæ–½**

   * Alembic ã‚’ä½¿ã‚ãªã„å ´åˆï¼š`metadata.create_all(engine)` ã§ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
   * Alembic ã‚’ä½¿ã†å ´åˆï¼š`alembic upgrade head`
   * `init.sql` ã‚’ä½¿ã†å ´åˆï¼šSQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€psycopg ã‚„ asyncpg çµŒç”±ã§æµã™

---

### âœ… Alembic or SQLã©ã¡ã‚‰ã‚’ä½¿ã†ï¼Ÿ

ã©ã¡ã‚‰ã§ã‚‚å¯èƒ½ã§ã™ãŒï¼š

* Alembic ã‚’ä½¿ã£ã¦ã„ãªã„ãªã‚‰ï¼š`Base.metadata.create_all(bind=engine)`
* ã™ã§ã« Alembic ã‚’å°å…¥ã—ã¦ã„ã‚‹ãªã‚‰ï¼š`alembic upgrade head` ã‚’ subprocess ã§å®Ÿè¡Œ
* æ—¢å­˜ã® `init.sql` ã‚’ä½¿ã„ãŸã„ãªã‚‰ï¼š

  ```python
  async with engine.begin() as conn:
      with open("path/to/init.sql") as f:
          await conn.execute(text(f.read()))
  ```

---

## âœ… ã¾ã¨ã‚

| é …ç›®                   | å†…å®¹                                                                             |
| -------------------- | ------------------------------------------------------------------------------ |
| âœ… æ–¹é‡ã®åŸºæœ¬              | `.envs/local/postgres` ã‚’æµç”¨ã—ã€DBåã ã‘ `app_test` ã«å¤‰æ›´                               |
| âœ… setup\_test\_dbã®å½¹å‰² | ãƒ†ã‚¹ãƒˆDBã‚’DROPâ†’CREATEã€ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–                                                      |
| âœ… init.sqlã¯å¿…è¦ï¼Ÿ       | Alembicã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆã¯ä½¿ç”¨ã—ã¦ã‚‚OKã€‚ãŸã ã— `Base.metadata.create_all()` ã®æ–¹ãŒFastAPIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯è‡ªç„¶ |
| âœ… ãƒ†ã‚¹ãƒˆç”¨DBã®ã‚¯ãƒªãƒ¼ãƒ³ã•       | ãƒ†ã‚¹ãƒˆã®ãŸã³ã«å†ä½œæˆã™ã‚‹ã‹ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å·»ãæˆ»ã—ã‚„truncateã§å¯¾å¿œå¯èƒ½                                       |

å¿…è¦ã§ã‚ã‚Œã°ã€`setup_test_db()` ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚‚æç¤ºã§ãã¾ã™ã€‚ã©ã†ã—ã¾ã™ã‹ï¼Ÿ


----

# è³ªå•6.

```
ãã†ã§ã™ã­ã€ã¾ãšã¯ã€ä»Šã¾ã§è€ƒãˆã¦ããŸæ–¹é‡ã‚’ã‚‚ã¨ã«ã€fastapi/integerate_testã«é…ç½®ã™ã‚‹æ–¹ã®conftest.pyã‚’è¦‹ã›ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ã€‚
```

---

ä»¥ä¸‹ã¯ã€ã“ã‚Œã¾ã§ã«æ¤œè¨ã—ã¦ããŸæ–¹é‡ã«æ²¿ã£ã¦ä½œæˆã—ãŸ `fastapi/integrate_tests/conftest.py` ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚ã“ã® `conftest.py` ã§ã¯ï¼š

* ãƒ†ã‚¹ãƒˆç”¨DBï¼ˆä¾‹: `app_test`ï¼‰ã‚’ä½œæˆ
* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ `metadata.create_all()` ã«ã‚ˆã‚Šç”Ÿæˆ
* ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ã§ãƒ†ã‚¹ãƒˆä¸­ã ã‘ä½¿ç”¨
* `init.sql` ã«ã¯ä¾å­˜ã—ãªã„æ§‹æˆ

---

## âœ… `fastapi/integrate_tests/conftest.py`

```python
import os
import asyncio
import pytest
from sqlalchemy.ext.asyncio import AsyncEngine, create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

from app.db import Base  # SQLAlchemyãƒ¢ãƒ‡ãƒ«ã®Base
from app.dependencies import get_db  # FastAPIã®Dependsã§ä½¿ã†DBä¾å­˜
from app.main import app

# ãƒ†ã‚¹ãƒˆç”¨DBåã‚’æŒ‡å®šï¼ˆæœ¬ç•ªã® .env ã¨ã¯åˆ‡ã‚Šé›¢ã™ï¼‰
TEST_DATABASE_URL = "postgresql+asyncpg://postgres:postgres@postgres:5432/app_test"


@pytest.fixture(scope="session")
def event_loop():
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ã§asyncioã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å…±æœ‰"""
    loop = asyncio.get_event_loop()
    yield loop
    loop.close()


@pytest.fixture(scope="session")
async def setup_test_db():
    """
    ãƒ†ã‚¹ãƒˆDBã‚’ä½œæˆã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
    ã“ã®fixtureã¯autouse=Falseï¼ˆæ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™ï¼‰
    """
    # ãƒ†ã‚¹ãƒˆç”¨DBæ¥ç¶šï¼ˆDBãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰
    admin_url = "postgresql+asyncpg://postgres:postgres@postgres:5432/postgres"
    admin_engine = create_async_engine(admin_url, echo=True, future=True)

    async with admin_engine.begin() as conn:
        # ãƒ†ã‚¹ãƒˆDBã‚’åˆæœŸåŒ–ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯DROPï¼‰
        await conn.execute("DROP DATABASE IF EXISTS app_test")
        await conn.execute("CREATE DATABASE app_test")
    await admin_engine.dispose()

    # ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
    test_engine = create_async_engine(TEST_DATABASE_URL, echo=True, future=True)
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    await test_engine.dispose()


@pytest.fixture()
async def async_session():
    """
    ãƒ†ã‚¹ãƒˆç”¨ã® AsyncSession ã‚’æä¾›
    â€» setup_test_db ã¯æ˜ç¤ºçš„ã«å‘¼ã¶ã“ã¨
    """
    engine = create_async_engine(TEST_DATABASE_URL, echo=True, future=True)
    async_session_maker = sessionmaker(
        engine, expire_on_commit=False, class_=AsyncSession
    )
    async with async_session_maker() as session:
        yield session
    await engine.dispose()


# FastAPIã‚¢ãƒ—ãƒªã«ãƒ†ã‚¹ãƒˆç”¨DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å·®ã—è¾¼ã‚€
@pytest.fixture(autouse=True)
def override_get_db(async_session):
    async def _override():
        yield async_session
    app.dependency_overrides[get_db] = _override
```

---

## âœ… ä½¿ç”¨ä¾‹ï¼ˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰

```python
@pytest.mark.asyncio
async def test_create_item(async_session, setup_test_db):
    # ãƒ†ã‚¹ãƒˆç”¨ã®DBã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç¢ºèª
    item = Item(name="Test")
    async_session.add(item)
    await async_session.commit()

    result = await async_session.get(Item, item.id)
    assert result.name == "Test"
```

---

## âœ… è§£èª¬ã¨è£œè¶³

* **`setup_test_db` ã¯ autouse=False ã«ã™ã‚‹**ï¼šæ˜ç¤ºçš„ã«ä½¿ã„ãŸã„ã¨ãã ã‘å‘¼ã¹ã‚‹ï¼ˆä»–ã®éDBãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ï¼‰
* **`async_session` ã¨ `override_get_db` ã¯å…¨ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ï¼ˆautouse=Trueï¼‰**ï¼šãŸã ã—ã€DBè‡ªä½“ã‚’åˆæœŸåŒ–ã¯ã—ãªã„
* **`event_loop` fixture**ï¼šéåŒæœŸãƒ†ã‚¹ãƒˆå…¨ä½“ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å…±æœ‰
* **`get_db` ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰**ï¼šFastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆæ™‚ã«ã‚‚æ­£ã—ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å·®ã—è¾¼ã‚€

---

## âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ä»¥ä¸‹ã®ã‚ˆã†ãªç”¨é€”ã«å¿œã˜ã¦ `integrate_tests/` ä»¥ä¸‹ã®æ§‹æˆã‚’ç´°åˆ†åŒ–ã—ã¦ã„ãã¨ã‚ˆã„ã§ã™ï¼š

* `integrate_tests/db/`ï¼šDBã‚’ä½¿ã†çµåˆãƒ†ã‚¹ãƒˆï¼ˆã“ã®conftest.pyãŒé©ç”¨ã•ã‚Œã‚‹ï¼‰
* `integrate_tests/api/`ï¼šHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹E2Eãƒ†ã‚¹ãƒˆï¼ˆ`TestClient` ã¾ãŸã¯ Playwright ç­‰ï¼‰
* `integrate_tests/mock/`ï¼šDBã‚’ä½¿ã‚ãšä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãƒ†ã‚¹ãƒˆï¼ˆåˆ¥é€”conftestï¼‰

å¿…è¦ã§ã‚ã‚Œã° `init.sql` ã‚’æµã™å‡¦ç†ã‚‚è¿½åŠ å¯èƒ½ã§ã™ã€‚ãã®éš›ã®å…·ä½“ä¾‹ã‚‚æç¤ºã§ãã¾ã™ã®ã§ã€å¿…è¦ã§ã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚


----
# ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

```
ä»¥ä¸‹ã®pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€unittest.mockã¯åˆ©ç”¨ã›ãšã€pytestã¨pytest-mockã®ã¿ã‚’åˆ©ç”¨ã—ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
- fastapi/app/infrastructure/sqlalchemy/repositories/category_repo_impl.py
ãªãŠã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆæ™‚ã«ã¯ä»¥ä¸‹ã®13ç‚¹ã‚’å®ˆã£ã¦ä½œæˆã—ã¦ä¸‹ã•ã„ã€‚
(1) 1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ãã€1ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œtest_(module_name).pyã€ã¨ã™ã‚‹
(2) 1ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«1ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆé–¢æ•°ã®é–¢æ•°åã¯å¿…ãšè‹±èªã§ä½œæˆã™ã‚‹ã€‚
(3) å†…å®¹ã«ã¤ã„ã¦ã¯ã€å¯¾è±¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦å¯¾å¿œã™ã‚‹1ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§c0,c1ã‚«ãƒãƒ¬ãƒƒã‚¸100%ã‚’ã¿ãŸã—ã€æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ç¶²ç¾…ã™ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
(4) docstringã¯å¿…ãšæ—¥æœ¬èªã§ä½œæˆã—ã€ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆé–¢æ•°ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ã©ã‚Œã«è©²å½“ã™ã‚‹ã‹ã‚’docstringã«ã¦ã€Œæ­£å¸¸ç³»:ã€ã€ã€Œç•°å¸¸ç³»:ã€ã€ã€Œã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹:ã€ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ã€‚
(5) å˜ä½“ãƒ†ã‚¹ãƒˆã®è¦³ç‚¹ã§å¿…è¦ãªãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨
(6) ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯`fastapi/integrate_tests`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«é…ç½®ã™ã‚‹ã“ã¨ã€‚å¯¾è±¡ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒéšå±¤ã«é…ç½®ã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã™ã‚‹ã€‚ä¾‹ãˆã°ã€å¯¾è±¡ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ`fastapi/app/domain/items/xxx.py`ã§ã‚ã‚‹ãªã‚‰ã°ã€ã“ã‚Œã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯`fastapi/integrate_tests/domain/items/test_xxx.py`ã¨ã—ã¦ä½œæˆã™ã‚‹ã“ã¨ã€‚
(7) ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒéåŒæœŸã®å ´åˆã€ãƒ†ã‚¹ãƒˆã«ã¯`@pytest.mark.anyio`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
(8) Lintãƒã‚§ãƒƒã‚¯ã«ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã»ã—ããªã„ã§ã™ã€‚ãªã®ã§ã€`docker compose exec ruff-fastapi basedpyright /fastapi/tests`ã‚³ãƒãƒ³ãƒ‰ã€`docker compose exec ruff-fastapi ruff check /fastapi/tests`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸéš›ã«ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
(9) ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã¯ã€`docker compose exec pytest-fastapi pytest integrate_tests`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒæ¡ä»¶ã‚’ã¿ãŸã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèªã«ã¯ã€`docker compose exec pytest-fastapi pytest integrate_tests \
  --cov=app --cov-branch \
  --cov-report=term-missing:skip-covered`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
(10) ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€docker compose ã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æœ€ä¸Šä½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«docker-compose.ymlãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚
(11) ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹éç¨‹ã§ã€pythonä»®æƒ³ç’°å¢ƒã®ä½œæˆã¯ã—ãªã„ã§ã ã•ã„ã€‚
(12) DBã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¼´ã†ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã»ã—ã„ã§ã™ã€‚DBè‡ªä½“ã¯docker compose ã‚’ç”¨ã„ã¦ã€postgresqlã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã™ã€‚ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€fastapi/integrate_tests/conftest.pyã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆç”¨ã®DBã€ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã€ãƒ†ã‚¹ãƒˆã‚’çµ‚äº†ã—ãŸã‚‰ã€ãã®ãƒ†ã‚¹ãƒˆç”¨DBã‚„ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å»ƒæ£„ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã»ã—ã§ã™ã€‚é–‹ç™ºç”¨ã®DBã‚„é–‹ç™ºç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚ã“ã®ç›®çš„ã®ãŸã‚ã«fastapi/integrate_tests/conftest.pyã‚’ç·¨é›†ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
(13) ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’äº‹å‰ã«æº–å‚™ã—ã¦ãŠããŸã„å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒéšå±¤ã«conftest.pyã‚’ä½œæˆã—ã€ãã“ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚
(14) ã„ã‹ãªã‚‹éšå±¤ã«é…ç½®ã—ã¦ã„ã‚‹conftest.pyã§ã‚ã‚ã†ã¨ã€auto_user=Trueã®ä½¿ç”¨ã¯ç¦æ­¢ã—ã¾ã™ã€‚
(15) integrate_test/conftest.pyã§ã¯ddl.sqlã®å†…å®¹ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å½¢ã«ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ã€‚